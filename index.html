<html>
    <style>

body{
    /* background: #8abeb7; */
    text-align: left;
    overflow-x: scroll;
    font-family : "TheSansMono Office";
    font-size : 11px;
    display: flex;
    flex-direction: column;

}

scroll-bar{
    display: none;
}

::-webkit-scrollbar{
    display: none;
}

.main {
    /* height: 440px; */
    display:flex;
    flex-direction: row;
}

.editor{
    width: 400px !important;
}

.editor-display{
    padding: -1px !important;
    border: 1px solid !important;
    border-radius: 0px !important;
    background: rgb(0, 0, 0, 0.1) !important;
}

.text{
    display:block;
    position: relative;
    margin: 10px;
}

#canvas-container{
    margin: 10px;
    display:block;
    position: relative;
    border: 1px solid;
}

</style>
<body>
    
    <div class="main">
        <div id="canvas-container"></div>
        <div class="text" id="editor"></div>
    </div>

</body>

<script src="./Editor.js"></script>
<script src="./Vec.js"></script>
<script>

    var strokes = {};

    Array.prototype.last = function(){
        return this[this.length - 1];
    }

    CanvasRenderingContext2D.prototype.lineToVec = function(vec){
        this.lineTo(vec.x, vec.y);
    }

    CanvasRenderingContext2D.prototype.moveToVec = function(vec){
        this.moveTo(vec.x, vec.y);
    }

    CanvasRenderingContext2D.prototype.bezierCurveTo = function(cv1, cv2, ev){
        this.bezierCurveTo(cv1.x, cv1.y, cv2.x, cv2.y, ev.x, ev.y);
    }

    CanvasRenderingContext2D.prototype.drawZig = function(vecs){
        try {
            let [first, ...rest] = vecs;
            this.moveToVec(first);
            for (let vec of rest){
                this.lineToVec(vec);
            }
        } catch {
            console.log('Illegal line segs: ', vecs);
        }
    }

    CanvasRenderingContext2D.prototype.draw = function(zigs){
        this.beginPath();
        for (let zigName in zigs){
            if(zigs[zigName].attr.hidden !== "true")
                this.drawZig(zigs[zigName].path);
        }
        this.stroke();
    }

    let tokenExec = function(tokens){

        for (;tokens.length > 0;){
            // try{
            let args = instrs[tokens[0]].args,
                expr = args === "*" ? 
                       tokens.splice(0) :
                       tokens.splice(0, args);
            let [name, ...params] = expr;
                instrs[name].func(...params);
            // } catch {
            //     console.log(`undefined: "${name}"`);
            //     tokens.splice(0, 1);
            // }
        }
            
    }

    let state = {
        path : {default: [new Vec(0,0)]},
        angle : {default: 0}
    }

    let gets = (key) => {
        return state[key].curr;
    }

    let sets = (key, val) => {
        state[key].curr = val;
        return true;
    }

    let resets = (key) => {
        if(Array.isArray(state[key].default))
            state[key].curr = state[key].default.map(e => e.copy());
        else if (typeof state[key].default === 'object')
            state[key].curr = state[key].default.copy();
        else
            state[key].curr = state[key].default;
    }

    let adds = (key, defaultValue) => {
        state[key] = {curr: undefined, default: defaultValue}
    }

    let inits = () => {
        for (let key in state){
            resets(key);
        }
    }

    let instrs = {

        end:{
            args: 1,
            func(name){
                console.log("unnamed path", JSON.stringify(gets('path')));
                ctx.beginPath();
                ctx.drawZig(gets('path').splice(0));
                ctx.stroke();
                resets('path');
            }
        },

        named: {
            args: 2,
            func(name){
                strokes[name] = {path: gets('path').splice(0), attr:{}};
                console.log(JSON.stringify(gets('path')));
                resets('path');
            }
        },

        ang: {
            args: 2,
            func(angle){
                sets('angle', parseFloat(angle));
            }
        },

        len: {
            args: 2,
            func(length){
                console.log(state);
                let newVec = (new Vec(gets('angle'))).mult(length).add(gets('path').last());
                gets('path').push(newVec);
                resets('angle');
            }
        },

        set: {
            args: 4,
            func(name, attr, value){
                strokes[name].attr[attr] = value;
            }
        },

        def: {
            args: '*',
            func(...args){
                let [name, argc, ...rest] = args;
                
                // if(name in instrs)
                //     throw Error('existing function');

                let argv = rest.splice(0, parseInt(argc));

                for (let arg of argv) if (arg in instrs)
                    throw Error(`arg name [${arg}] shouldn't be same as reserved keyword`);

                console.log('argv ', argv);
                console.log('rest ', rest);
                
                let theArgMappingTable = argv.map(arg => rest.indexOf(arg));
                console.log('angleMapping ', theArgMappingTable);
                instrs[name] = {
                    args: parseInt(argc)+1,
                    func: (function(argMappingTable, tokens){
                        return function(...funcArgs){
                            for (let i = 0; i < funcArgs.length; i++){
                                tokens[argMappingTable[i]] = funcArgs[i];
                            }
                            console.log(tokens)
                            tokenExec(tokens.slice());
                        }
                    })(theArgMappingTable, rest)
                };
            }
        }
    }


    let submitFunc = function(text) {

        let textlines = text.split(';');

        ctx.save();
        ctx.setTransform(1,0,0,1,0,0);
        // Will always clear the right space
        ctx.clearRect(0, 0, dpr*ctx.canvas.width, dpr*ctx.canvas.height);
        ctx.restore();

        for (let expr of textlines) {
            let tokens = expr.trim().split(/[\s\n]+/);
            console.log(tokens);
            tokenExec(tokens);
        }

        ctx.draw(strokes);
    }

    let canvas = document.createElement('canvas'),
        ctx = canvas.getContext('2d'),
        dpr = window.devicePixelRatio;
    canvas.width  = 400 * dpr;
    canvas.height = 400 * dpr;
    canvas.style.width  = 400;
    canvas.style.height = 400;
    document.getElementById('canvas-container').appendChild(canvas);
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.scale(dpr, dpr);

    let editorElement = document.getElementById('editor');
    let editor = new Editor(editorElement, submitFunc);
    
    inits();

</script>

</html>

